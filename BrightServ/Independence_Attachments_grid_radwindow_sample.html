<%@ Control %>
<style>
  .colAttachmentDelete {
    border-left: none !important;
  }
  .gridDeleteLink {
    display: <%={IIF(ToString(act.Status) == "Completed", "none", "")} %>;
  }
  .mySelect.rgSelectedRow.rgRow{
    background-color:rgba(148, 0, 17, 1) !important;
  }
  .rgAltRow.rgSelectedRow.mySelect{
    background-color:rgba(148, 0, 17, 1) !important;
  }
  .mySelect.rgSelectedRow.rgRow > td{
    border-color:white;
  }
  .rgAltRow.rgSelectedRow.mySelect > td{
    border-color:white;
  }
  .rgSelectedRow.rgRow * span.rbText{
    color:white !important;
  }
  .rgAltRow.rgSelectedRow * span.rbText{
    color:white !important;
  }
  .rbClearButton {
    background-color: transparent !important;
    border: none !important;
    /*color: #000 !important;*/ /* optional, depending on the background */
  }
  .rbClearButton > .rbText {
    text-decoration:underline !important;
  }
  .statusFeed{
    display:inline-block;
    color:red;
    border:1px solid red;
    padding: 2px;
    margin-left:7px;
    font-size:80%;
  }
  .statusFeed .tooltip {
    visibility: hidden;
    width: 180px;
    background-color: #fffAF0;
    color: black;
    text-align: left;
    border-radius: 3px;
    border-color:black;
    margin-left:35px;
    margin-top: -10px;
    padding: 5px 5px 5px 5px;
    box-shadow: 5px 5px 8px #CCC;
    position: absolute;
    z-index: 1;
    font-size:110%;
  }
  .statusFeed:hover .tooltip {
    visibility: visible;
  }

</style>

<script type="text/javascript">

  var fileUploadErrorTooltip ="Upload to document repository failed. Please try again. Contact support if problem persists.";
  var fileDeleteErrorTooltip ="Delete from document repository failed. Please try again. Contact support if problem persists.";
  var newFileTooltip="Newly updloaded documents will be editable after Save or Submit.";


  Sys.WebForms.PageRequestManager.getInstance().add_pageLoaded(AttsGridUPLoaded);

  function AttsGridUPLoaded(sender,args){
    if(sender._postBackSettings != null && sender._postBackSettings.panelsToUpdate != null)
    {
      //debugger;
      if(sender._postBackSettings.panelsToUpdate[0].indexOf("attachUpdatePanel") > -1 && 	sender._activeElement != null &&
         (sender._activeElement.id.indexOf("PerformInsertButton") > -1 || sender._activeElement.id.indexOf("AutoGeneratedDeleteButton") > -1))
      {
        if (typeof OnEditAttachmentsGridCreatedHook == 'function')
        {        
          OnEditAttachmentsGridCreatedHook();
        }
      }
    }
  }

  //Delete Related Functions
  function OnClientDeletedFile(sender, args){    
    var status = sender.get_parent().getDataKeyValue("status");
    if(status >= 1){//If the document is already uploaded to SHP

      var row = sender.get_parent();
      var fldid = $sq(row.get_cell("fldId")).text();
      var txtSelectedIds = $find($sq('[id$=txtSelecteIdsToDelete]')[0].id);
      var selectedIds = txtSelectedIds.get_value();

      if(sender.get_text()=="Delete"){
        if(confirm("Are you sure you want to delete this attachment?")){
          row.addCssClass("rgSelectedRow");
          row.addCssClass("mySelect");
          sender.set_text("Undo");
          txtSelectedIds.set_value(selectedIds + fldid + ";");
          $sq($sq('[id$="pendingDeleteTxt"]')[0]).css("display","block");
        }
      } else {
        row.removeCssClass("rgSelectedRow");
        row.removeCssClass("mySelect");
        sender.set_text("Delete");
        var newValue = selectedIds.replace(fldid+";","");
        txtSelectedIds.set_value(newValue);
        if(newValue.length == 0){
          $sq($sq('[id$="pendingDeleteTxt"]')[0]).css("display","none");
        }
      }
    }else{//document is only Sequence Document
      var index = sender.get_parent()._itemIndexHierarchical;
      var mtv = sender.get_parent().get_parent();
      mtv.deleteItem(index);
      console.log(mtv);
      console.log(index);
    }
  }

  function AttachmentHistory_OnRowCreated(sender, args){
    var rowEditButtonItem = args.get_gridDataItem();
    var rowDeleteButton = rowEditButtonItem.get_cell("DeleteColumn");  
    var key = args.getDataKeyValue("fldId");

    selectDeletedRow(key,args._id);
    addStatusFeedBack(args.getDataKeyValue("status"),args.get_gridDataItem().get_cell("sharepointAttachURL"));
  }

  //END of Delete Related Functions
  function gridAttach_onRowCreate(sender, args)
  {
    var rowEditButtonItem = args.get_gridDataItem();
    var rowEditButton = rowEditButtonItem.get_cell("EditColumn");
    var rowDeleteButton = rowEditButtonItem.get_cell("DeleteColumn");    
    var showVersionsCell = rowEditButtonItem.get_cell("versionHst");
    var key = args.getDataKeyValue("fldId");

    if(rowEditButton != null){
      rowEditButton.style.display = 'none';

    }

    if($sq(showVersionsCell).find('[id$="hf_fileUrl"]')[0].value == ""){
      $sq($sq(showVersionsCell).find('[id$="btn_showVersions"]')[0]).toggle();
    }

    selectDeletedRow(key,args._id);
    addStatusFeedBack(rowEditButtonItem.getDataKeyValue("status"),rowEditButtonItem.get_cell("attachment"));
  }

  function selectDeletedRow(key,rowId){
    var selectedIds = $sq($sq('[id$=txtSelecteIdsToDelete]')[0]).val();
    if(selectedIds.indexOf(key) > -1){
      var row = getElementByClientId(rowId)._element;
      row.className = row.className + " rgSelectedRow mySelect";
      var button = $find($sq(row).find('[id$="DeleteButton"]')[0].id);
      button.set_text("Undo");
    } 
  }

  function RaiseCommand(sender, args)
  {
    var obj=getElementById("RUC_attachment");

    if(args.get_commandName() == "PerformInsert")
    {
      if(obj.getUploadedFiles().length == 0)
      {
        alert("Please select the upload file");
        args.set_cancel(true);
      }

    }
  }

  Sys.Application.add_load(AttachHSTLoad);

  function AttachHSTLoad()
  {

    var commentsGrid = getElementById("Grd_AttachmentHistory");
    var MasterTable = commentsGrid.get_masterTableView();
    var numberOfItems = MasterTable.get_dataItems().length;

    if(numberOfItems > 0)
    {
      $("#attachmentLabel_TR").show();
      $("#attachmentGrid_TR").show();
    }

    if(localStorage.getItem("OccuredSave") == "1"){
      getElementById("UACT_AttachmentsGridView").get_masterTableView().rebind();
      localStorage.setItem("OccuredSave",0);
    }
  }

  var modal = null;
  function ShowSelectionDialog(url){
    if(modal ==  null){
      modal = $find($sq('[id$="modalPopup"]')[0].id);
    }
    modal.setUrl(url);
    modal.show();
  }

  function ShowVersions(sender, args){
    var url = window.location.href;
    var splitedURL = url.split('/');
    var fileURL = $sq(sender.get_parent().get_element()).find('[id$="hf_fileUrl"]')[0].value;
    fileURL = encodeURIComponent(fileURL.split('/').slice(3).join('/'));
    splitedURL[splitedURL.length-1] = "Versions.aspx?FileName=";
    url = splitedURL.join('/') + '/' + fileURL + '&IsDlg=1';
    ShowSelectionDialog(url);
  }

  function OnModalClose(sender, args){  
    modal.setUrl("");
  }

  function ExistDocumentsToUpload(){
    var exists = false;
    var gridMTV = $find($sq('[id$="UACT_AttachmentsGridView"]')[0].id).get_masterTableView();
    for (var i = 0; i != gridMTV.get_dataItems().length; i++){
      if(gridMTV.get_dataItems()[i].getDataKeyValue("status") == "0"){
        exists = true;
        break;
      }
    }
    return exists;
  }

  function UploadDocuments(){

    if(ExistDocumentsToUpload()){
      var webServiceUrl = $find($sq('[id$="ODataDS"]')[0].id).get_serviceUrl()+"SharepointUploadDocuments";
      var serviceUrl = window.location.protocol+ '//' + window.location.host + webServiceUrl.substr(5,webServiceUrl.length);
      $sq.ajax({
        type:     "get",
        contentType:  "application/json; charset=utf-8",
        dataType:   "json",
        url:      serviceUrl, 
        headers:    {"X-SqXsrfToken": $sq("#__SqXsrfTokenValue").val() },
        success: function (data, textStatus, XmlHttpRequest1) {
          SyncAttachmentsBarrier();
          /*console.log(data);
            console.log(textStatus);
            console.log(XmlHttpRequest1);*/
        },
        error: function (data, textStatus, XmlHttpRequest1) {
          SyncAttachmentsBarrier();
          console.error("Error On Attachments Upload!");
          console.log(data);
          console.log(textStatus);
          console.log(XmlHttpRequest1);
        }
      }); 
    }else{
      SyncAttachmentsBarrier();		
    }
  }

  function ExistDocumentsToDelete(){
    var txtSelectedIds = $find($sq('[id$=txtSelecteIdsToDelete]')[0].id);
    var selectedIds = txtSelectedIds.get_value();
    if(selectedIds.length > 0){		
      return true;
    }
    return false;
  }

  function DeleteDocuments(){
    if(ExistDocumentsToDelete()){
      var txtSelectedIds = $find($sq('[id$=txtSelecteIdsToDelete]')[0].id);
      var libraryName = "<%={wf.Variables["SharepointLibraryName"]}%>";
      var wfInstanceIdIntake = "<%={wf.Variables["ParentWfId"]} %>";
      var selectedIds = txtSelectedIds.get_value();
      var webServiceUrl = $find($sq('[id$="ODataDS"]')[0].id).get_serviceUrl()+"SharepointDeleteDocuments?idsToDelete='"+encodeURIComponent(selectedIds)+"'";
      var serviceUrl = window.location.protocol+ '//' + window.location.host + webServiceUrl.substr(5,webServiceUrl.length);
      txtSelectedIds.clear();
      $sq.ajax({
        type:     "get",
        contentType:  "application/json; charset=utf-8",
        dataType:   "json",
        url:      serviceUrl, 
        headers:    {"X-SqXsrfToken": $sq("#__SqXsrfTokenValue").val() },
        success: function (data, textStatus, XmlHttpRequest1) {
          console.log(data);
          console.log(textStatus);
          console.log(XmlHttpRequest1);
          SyncAttachmentsBarrier();
        },
        error: function (data, textStatus, XmlHttpRequest1) {
          console.error("Error On Attachments Delete!");
          console.log(data);
          console.log(textStatus);
          console.log(XmlHttpRequest1);
          SyncAttachmentsBarrier();
        }
      }); 
    }else{
      SyncAttachmentsBarrier();
    }
  }

  function UpdateDocuments(fieldsToUpdate){
    var updateParameters = PrepareInvokation(fieldsToUpdate);
    if(updateParameters.trim() != ""){

      var webServiceUrl = $find($sq('[id$="ODataDS"]')[0].id).get_serviceUrl()+"SharepointUpdateDocuments?"+updateParameters;
      var serviceUrl = window.location.protocol+ '//' + window.location.host + webServiceUrl.substr(5,webServiceUrl.length);
      $sq.ajax({
        type:     "get",
        contentType:  "application/json; charset=utf-8",
        dataType:   "json",
        url:      serviceUrl, 
        headers:    {"X-SqXsrfToken": $sq("#__SqXsrfTokenValue").val() },
        success: function (data, textStatus, XmlHttpRequest1) {
          /* console.info("Success on Attachments Update!");
          console.log(data);
          console.log(textStatus);
          console.log(XmlHttpRequest1);*/
          SyncAttachmentsBarrier();
        },
        error: function (data, textStatus, XmlHttpRequest1) {
          console.error("Error On Attachments Update!");
          console.log(data);
          console.log(textStatus);
          console.log(XmlHttpRequest1);
          SyncAttachmentsBarrier();
        }
      }); 

    }else{
      SyncAttachmentsBarrier();
    }
  }

  var syncBarrierUp = false;
  var barrierCount = 3;
  var maxCount = 20;
  //this barrier is intended to be used in cases where we need to be sure that the attachments were all synced
  function SyncAttachmentsBarrier(){
    if(syncBarrierUp && barrierCount > 0){ // barrier was turned ON
      barrierCount--;
      if(barrierCount == 0){ //resets the barrier. It means all sync related funcions were executed
        syncBarrierUp = false;
        barrierCount = 3;
        maxCount = 20;
      }
    }else{ // first execution of the barrier. It is turned on and count set to 3
      syncBarrierUp = true;
    }
  }

  //this function is intended to sleep the main thread while the barrier is up
  function WaitForAttachmentsBarrier(callBackFunction){
    setTimeout(function(){
      if(syncBarrierUp && maxCount > 0){
        maxCount--;
        WaitForAttachmentsBarrier(callBackFunction);
      }else{
        if(typeof callBackFunction === "function"){
          callBackFunction();
        }
      }
    },500);
  }

  function PrepareInvokation(fieldsToUpdate){    
    var updateParameters = "";
    for(var key in fieldsToUpdate){
      if(key != undefined && fieldsToUpdate[key].type != "datetime"){
        updateParameters += "&" + fieldsToUpdate[key].name + "='" + encodeURIComponent(fieldsToUpdate[key].value) + "'";			
      }else if(key != undefined && fieldsToUpdate[key].type == "datetime"){
        updateParameters += "&" + fieldsToUpdate[key].name + "=" + fieldsToUpdate[key].value;
      }
    }

    return updateParameters.substr(1, updateParameters.length - 1);
  }

  function SyncAttachments(){
    SyncAttachments(null);
  }

  function SyncAttachments(fieldsToUpdate){
    SyncAttachmentsBarrier();
    UploadDocuments();
    DeleteDocuments();
    UpdateDocuments(fieldsToUpdate);
    try {
    	localStorage.setItem("OccuredSave",1);
    } catch(e) {}
  }

  function addStatusFeedBack(status, cell){
    switch (status){
      case "0":
        presentStatusFeedback(cell,"New",newFileTooltip);
        break;
      case "2": 
        presentStatusFeedback(cell,"Failed",fileUploadErrorTooltip);
        break;
      case "4":
        presentStatusFeedback(cell,"Failed",fileDeleteErrorTooltip);
        break;
      default:
        break;
    }
  }
  function presentStatusFeedback(cell,text,tooltip){
    var div = $sq(cell).find("#statusFeed")[0];
    var span = $sq(cell).find("#tooltip")[0];
    /*
    $sq(span).append(tooltip);
    $sq(div).append(text);
    $sq(div).show();
    */
  }



  $sq(document).ready(
    function(){

      var gridatts = $find($sq('[id$="UACT_AttachmentsGridView"]')[0].id);
      var gridHST = $find($sq('[id$="Grd_AttachmentHistory"]')[0].id);
      if($sq(gridatts.get_element()).find('[id$="AddNewRecordButton"]').length == 0){
        gridHST.get_masterTableView().hideColumn(9);
        gridatts.get_masterTableView().hideColumn(9);
      }
    }
  );


</script>



<table class="sqf-main-table" ID="attachmentsTable" cellpadding="0" cellspacing="0"  width="100%">
  <tr class="sqf-header">
    <td colspan="4"  class="sqf-header-td">

      <sq:Label runat="server" Text="Attachments" ID="Label0" ForeColor="White" Font-Size="28px"></sq:Label>
    </td>
  </tr>  

  <tr id="attachmentLabel_TR" style="display:none">
    <td colspan="2">
      <br>
      <sq:Label runat="server" Text="Previous Loaded Attachments:" ID="lbl_prevload"></sq:Label>
    </td>
  </tr>  


  <tr id="attachmentGrid_TR" style="display:none">
    <td colspan="2">
      <asp:UpdatePanel id="attach_HstUP" runat="server" EnableViewState="false"><ContentTemplate>
        <sq:DataSource runat="server" ID="DataSource1" QueryName="Attachments_History_UACT" 
                       Where="fldIActId &lt; @fldIActId and (fldiWFId == @currentWFID or fldiWFId == @otherWFID) AND iactIdWhereDeleted == NULL AND isForFDC == NULL AND attachmentText!=NULL"><WhereParameters>
<sq:ExpressionParameter Expression="Act.ActivityInstanceId" Name="fldIActId"></sq:ExpressionParameter>
<sq:TemplateControlParameter PropertyName="Parameters[&quot;currentWFID&quot;]" Name="currentWFID"></sq:TemplateControlParameter>
<sq:TemplateControlParameter PropertyName="Parameters[&quot;otherWFID&quot;]" Name="otherWFID"></sq:TemplateControlParameter>
</WhereParameters>
</sq:DataSource>
        <div style="display:none" id="pendingDeleteTxt">
          <sq:Label runat="server" Text="Items pending deletion will be deleted after save or submission" ID="lblPendingDelete" ForeColor="#FF0000"></sq:Label>					
        </div>
        <sq:Grid runat="server" ID="Grd_AttachmentHistory" DataSourceID="DataSource1"  CellSpacing="0" 
                 GridLines="None" Width="100%" EnableViewState="false">
          <MasterTableView CommandItemDisplay="None" DataKeyNames="fldId" ClientDataKeyNames="fldId,status" DataSourceID="DataSource1" EditMode="InPlace" AutoGenerateColumns="False"><NoRecordsTemplate>
            <sq:Label runat="server" Text="" ID="lbl_norecord"></sq:Label>


            </NoRecordsTemplate>

            <RowIndicatorColumn Visible="True"></RowIndicatorColumn>

            <ExpandCollapseColumn Visible="True"></ExpandCollapseColumn>
            <Columns>
              <sq:GridNumericColumn DecimalDigits="0" DataField="fldId" ReadOnly="True" HeaderText="fldId" SortExpression="fldId" Display="False" UniqueName="fldId" DataType="System.Int32"></sq:GridNumericColumn>
              <sq:GridNumericColumn DecimalDigits="0" DataField="fldIWfId" ReadOnly="True" HeaderText="fldIWfId" SortExpression="fldIWfId" Display="False" UniqueName="fldIWfId" DataType="System.Int32"></sq:GridNumericColumn>
              <sq:GridNumericColumn DecimalDigits="0" DataField="fldIActId" ReadOnly="True" HeaderText="fldIActId" SortExpression="fldIActId" Display="False" UniqueName="fldIActId" DataType="System.Int32"></sq:GridNumericColumn>
              <sq:GridNumericColumn DecimalDigits="0" DataField="fldAIId" ReadOnly="True" HeaderText="fldAIId" SortExpression="fldAIId" Display="False" UniqueName="fldAIId" DataType="System.Int32"></sq:GridNumericColumn>
              <sq:GridNumericColumn DecimalDigits="0" DataField="status" EmptyDataText="12" DefaultInsertValue="12" HeaderText="status" SortExpression="status" Display="False" UniqueName="status" DataType="System.Int32"></sq:GridNumericColumn>

              <sq:GridTemplateColumn DataField="sharepointAttachURL" HeaderText="URL" SortExpression="sharepointAttachURL" UniqueName="sharepointAttachURL"><EditItemTemplate>
                <asp:TextBox runat="server" ID="sharepointAttachURLTextBox"></asp:TextBox>
                <sq:BindableControl runat="server" TargetControlID="sharepointAttachURLTextBox" DataField="sharepointAttachURL" />




                </EditItemTemplate>
                <ItemTemplate>

                  <span style='<%#{iif(String.IsNullOrEmpty(ds.Item.sharepointAttachURL),"display:none","")}%>;' __ds__id="30">
                    <sq:HyperLink runat="server"
                                  Text="<%# Bind('attachmentText') %>"
                                  ID="HyperLink1"
                                  NavigateUrl="<%# Bind('sharepointAttachURL') %>"
                                  target="_blank"
                                  />
                  </span> 
                  <span style='<%#{iif(String.IsNullOrEmpty(ds.Item.sharepointAttachURL),"","display:none")}%>;' __ds__id="32">
                    <asp:LinkButton ID="seq_attachment" runat="server" ToolTip="" CommandName="DownloadAttachment" CausesValidation="false"/>
                  </span> 

                  <sq:BindableControl runat="server" TargetControlID="seq_attachment" DataField="attachment"></sq:BindableControl>

                  <div Id="statusFeed" class="statusFeed" style="display:none" > 
                    <span Id="tooltip" class="tooltip" ></span>
                  </div>


                </ItemTemplate>
              </sq:GridTemplateColumn>
              <sq:GridBoundColumn DataField="User" HeaderText="User" SortExpression="User" UniqueName="User"></sq:GridBoundColumn>
              <sq:GridDateTimeColumn DataField="Date" HeaderText="Date" SortExpression="Date" UniqueName="Date" DataType="System.DateTime"></sq:GridDateTimeColumn>
              <sq:GridTemplateColumn HeaderText="Version History" UniqueName="versionHst" Display="False"><ItemTemplate>

                <sq:Button runat="server"  Text="View Versions"  ID="btn_showVersions" 
                           OnClientClicked="ShowVersions" ButtonType="LinkButton" 
                           CausesValidation="False" AutoPostBack="False" UseSubmitBehavior="False" CssClass="rbClearButton"
                           ></sq:Button>
                <asp:HiddenField runat="server" ID="hf_fileUrl"></asp:HiddenField>
                <sq:BindableControl runat="server" TargetControlID="hf_fileUrl" DataField="sharepointAttachURL"></sq:BindableControl>



                </ItemTemplate>
              </sq:GridTemplateColumn>
              <sq:GridTemplateColumn UniqueName="DeleteColumn"><ItemTemplate>
                <div class="gridDeleteLink">
                  <sq:Button runat="server" Text="Delete" ID="DeleteButton"
                             ButtonType="LinkButton" CausesValidation="False" 
                             AutoPostBack="False" EnableViewState="False" 
                             OnClientClicked="OnClientDeletedFile" CssClass="rbClearButton"
                             ></sq:Button>
                </div>
                </ItemTemplate>
                <EditItemTemplate></EditItemTemplate>
              </sq:GridTemplateColumn>
              <sq:GridTemplateColumn DataField="iactIdWhereDeleted" HeaderText="iactIdWhereDeleted" ShowSortIcon="False" Display="False" Resizable="False" Reorderable="False" UniqueName="iactIdWhereDeleted"><ItemTemplate>
                <asp:TextBox runat="server" ID="iactIdWhereDeletedTextBox"></asp:TextBox>
                <sq:BindableControl runat="server" TargetControlID="iactIdWhereDeletedTextBox" DataField="iactIdWhereDeleted" />

                </ItemTemplate>
              </sq:GridTemplateColumn>
            </Columns>
          </MasterTableView>

          <ClientSettings>
            <ClientEvents OnRowCreated="AttachmentHistory_OnRowCreated" OnCommand="RaiseCommand" ></ClientEvents>
          </ClientSettings>
        </sq:Grid>
        <sq:boundcontrol runat="server" TargetControlId="Grd_AttachmentHistory"></sq:boundcontrol>

        
</ContentTemplate>
</asp:UpdatePanel>
    </td></tr>


  <tr id="attchmentEditGrid_TR">
    <td>
      <asp:UpdatePanel id="attachUpdatePanel" runat="server"><ContentTemplate>
        <sqr:RadAjaxLoadingPanel runat="server" style="position:absolute;" ID="AttachmentsLoadingPnl" skin="Metro" IsSticky="true"  MinDisplayTime="200" ZIndex="1" EnableTheming="false"  >
        </sqr:RadAjaxLoadingPanel>

        <sq:Grid runat="server" ID="UACT_AttachmentsGridView" DataSourceID="UACT_AttachmentsDataSource" 
                 Width="100%"
                 AllowAutomaticDeletes="True" AllowAutomaticInserts="True"   CellSpacing="0" GridLines="None" AutoGenerateColumns="False" AllowAutomaticUpdates="True">
          <MasterTableView CommandItemDisplay="Bottom" DataKeyNames="fldId" ClientDataKeyNames="fldId,status" NoMasterRecordsText="" DataSourceID="UACT_AttachmentsDataSource" EditMode="InPlace" ShowHeader="False"><NoRecordsTemplate>
            <sq:Label runat="server" Text="" ID="lbl_norecord"></sq:Label>



            </NoRecordsTemplate>

            <CommandItemSettings AddNewRecordText="Add Attachment"></CommandItemSettings>

            <RowIndicatorColumn Visible="True"></RowIndicatorColumn>

            <ExpandCollapseColumn Visible="True"></ExpandCollapseColumn>
            <Columns>
              <sq:GridNumericColumn DecimalDigits="0" DataField="fldId" ReadOnly="True" HeaderText="fldId" SortExpression="fldId" Display="False" UniqueName="fldId" DataType="System.Int32"></sq:GridNumericColumn>
              <sq:GridNumericColumn DecimalDigits="0" DataField="fldIWfId" ReadOnly="True" HeaderText="fldIWfId" SortExpression="fldIWfId" Display="False" UniqueName="fldIWfId" DataType="System.Int32"></sq:GridNumericColumn>
              <sq:GridNumericColumn DecimalDigits="0" DataField="fldIActId" ReadOnly="True" HeaderText="fldIActId" SortExpression="fldIActId" Display="False" UniqueName="fldIActId" DataType="System.Int32"></sq:GridNumericColumn>
              <sq:GridNumericColumn DecimalDigits="0" DataField="fldAIId" ReadOnly="True" HeaderText="fldAIId" SortExpression="fldAIId" Display="False" UniqueName="fldAIId" DataType="System.Int32"></sq:GridNumericColumn>
              <sq:GridNumericColumn DecimalDigits="0" DataField="status" EmptyDataText="12" DefaultInsertValue="12" HeaderText="status" SortExpression="status" Display="False" UniqueName="status" DataType="System.Int32"></sq:GridNumericColumn>
              <sq:GridTemplateColumn DataField="attachment" HeaderText="attachment" SortExpression="attachmentText" UniqueName="attachment"><EditItemTemplate>
                <sq:AsyncFileUpload runat="server" ID="RUC_attachment" DisablePlugins="true" OnClientFileSelected="OnFileSelected" >
                  <Localization Select="Browse"></Localization>
                </sq:AsyncFileUpload>

                <sq:BindableControl runat="server" TargetControlID="RUC_attachment" DataField="attachment" />


                </EditItemTemplate>
                <ItemTemplate>
                  <span style='<%#{iif(String.IsNullOrEmpty(ds.Item.sharepointAttachURL),"display:none","")}%>;' __ds__id="30">
                    <sq:HyperLink runat="server"
                                  Text="<%# Bind('attachmentText') %>"
                                  ID="HyperLink2"
                                  NavigateUrl="<%# Bind('sharepointAttachURL') %>"
                                  target="_blank"
                                  />
                  </span> 
                  <span style='<%#{iif(String.IsNullOrEmpty(ds.Item.sharepointAttachURL),"","display:none")}%>;' __ds__id="32">
                    <asp:LinkButton ID="gac_attachment" runat="server" ToolTip="" CommandName="DownloadAttachment" CausesValidation="false"/>
                  </span>
                  <sq:BindableControl runat="server" TargetControlID="gac_attachment" DataField="attachment" />

                  <div Id="statusFeed" class="statusFeed" style="display:none" > 
                    <span Id="tooltip" class="tooltip" ></span>
                  </div>


                </ItemTemplate>
              </sq:GridTemplateColumn>
              <sq:GridTemplateColumn DataField="User" HeaderText="User" SortExpression="User" UniqueName="User">
                <EditItemTemplate>
                <asp:Literal runat="server" Mode="Encode" ID="UserLiteral"></asp:Literal>
                <sq:BindableControl runat="server" TargetControlID="UserLiteral" DataField="User" />


                </EditItemTemplate>
                <ItemTemplate>
                  <asp:Literal runat="server" Mode="Encode" ID="UserLiteral" ></asp:Literal>
                  <sq:BindableControl runat="server" TargetControlID="UserLiteral" DataField="User" /> 


                </ItemTemplate>
              </sq:GridTemplateColumn>
              <sq:GridTemplateColumn DataField="Date" HeaderText="Date" SortExpression="Date" UniqueName="Date" DataType="System.DateTime"><EditItemTemplate>
                <asp:Literal  runat="server" Mode="Encode" ID="DateLiteral"></asp:Literal>
                <sq:BindableControl runat="server" TargetControlID="DateLiteral" DataField="Date" />


                </EditItemTemplate>
                <ItemTemplate>
                  <asp:Literal  runat="server" Mode="Encode" ID="DateLiteral"></asp:Literal>
                  <sq:BindableControl runat="server" TargetControlID="DateLiteral" DataField="Date" />


                </ItemTemplate>
              </sq:GridTemplateColumn>
              <sq:GridTemplateColumn HeaderText="Version History" Display="False" UniqueName="versionHst"><InsertItemTemplate>


                </InsertItemTemplate>
                <ItemTemplate>
                  <sq:Button runat="server" Text="View Versions" ID="btn_showVersions" 
                             OnClientClicked="ShowVersions" ButtonType="LinkButton" 
                             CausesValidation="False" AutoPostBack="False" UseSubmitBehavior="False" CssClass="rbClearButton"></sq:Button>
                  <asp:HiddenField runat="server" ID="hf_fileUrl"></asp:HiddenField>
                  <sq:BindableControl runat="server" TargetControlID="hf_fileUrl" DataField="sharepointAttachURL" ></sq:BindableControl>


                </ItemTemplate>
              </sq:GridTemplateColumn>
              <sq:GridTemplateColumn UniqueName="DeleteColumn">
                <ItemStyle CssClass="colAttachmentDelete"></ItemStyle>
                <ItemTemplate>
                <div class="gridDeleteLink">
                  <sq:Button runat="server" Text="Delete" ID="DeleteButton" 
                             class="gridDeleteLink"
                             ButtonType="LinkButton" CausesValidation="False" 
                             AutoPostBack="False" EnableViewState="False" 
                             OnClientClicked="OnClientDeletedFile" CssClass="rbClearButton"></sq:Button>

                </div>
                </ItemTemplate>
                <EditItemTemplate></EditItemTemplate>
              </sq:GridTemplateColumn>
              <sq:GridEditCommandColumn UniqueName="EditColumn"></sq:GridEditCommandColumn>
            </Columns>

            <EditFormSettings>
              <EditColumn UniqueName="EditColumn"></EditColumn>
            </EditFormSettings>
          </MasterTableView>

          <ClientSettings>
            <ClientEvents OnRowCreated="gridAttach_onRowCreate" OnCommand="RaiseCommand"></ClientEvents>
          </ClientSettings>
        </sq:Grid>
        <sq:DataSource runat="server" ID="UACT_AttachmentsDataSource" 
                       QueryName="Attachments_UACT"	EnableUpdate="true" EnableInsert="true" EnableDelete="true"  
                       Where="fldIActId = @fldIActId AND isForFDC == NULL AND iactIdWhereDeleted == NULL">
          <whereparameters>
            <sq:expressionparameter expression="Act.ActivityInstanceId" name="fldIActId"></sq:expressionparameter>
          </whereparameters>
        </sq:DataSource>
        <sq:BoundControl runat="server" TargetControlID="UACT_AttachmentsGridView" ></sq:BoundControl>






        </ContentTemplate>
      </asp:UpdatePanel>

    </td>
  </tr>
</table>
<sq:DataSource runat="server" ID="DataSource2" QueryName="Attachments_info_uact" Where="fldiactid == @fldiactid"><WhereParameters>
  <sq:ExpressionParameter Expression="act.activityInstanceId" Name="fldiactid"></sq:ExpressionParameter>
  </WhereParameters>
</sq:DataSource>
<div style="display:none">
  <sq:Form runat="server" ID="Form1" DataSourceID="DataSource2" DataKeyNames="fldId" Height="100%" Width="100%"><ContentTemplate>
    <sq:TextBox runat="server" ID="txtSelecteIdsToDelete"></sq:TextBox>
    <sq:BindableControl runat="server" TargetControlID="txtSelecteIdsToDelete" DataField="selectedIdsToDelete"></sq:BindableControl>
    </ContentTemplate>
  </sq:Form>
  <sq:BoundControl runat="server" TargetControlID="Form1"></sq:BoundControl>
</div>


<sqr:RadWindow runat="server" ShowContentDuringLoad="true"   RenderMode="Lightweight" ID="modalPopup" Width="800px" Height="550px" Modal="true"
               Behaviors="Close" OnClientClose="OnModalClose" EnableViewState="false" DestroyOnClose="false" >
</sqr:RadWindow>


