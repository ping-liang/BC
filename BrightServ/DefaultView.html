<%@ Control %>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" type="text/css" />
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" type="text/javascript"></script>
<script language="Javascript">
  var popUp;
  function popUpShowing(sender, eventArgs) {
    popUp = eventArgs.get_popUp();
    //var gridWidth = sender.get_element().offsetWidth;
   // var gridHeight = sender.get_element().offsetHeight;
    var popUpWidth = popUp.style.width.substr(0, popUp.style.width.indexOf("px"));
    var popUpHeight = popUp.style.height.substr(0, popUp.style.height.indexOf("px"));
   // popUp.style.left = ((gridWidth - popUpWidth) / 2 + sender.get_element().offsetLeft).toString() + "px";
   // popUp.style.top = ((gridHeight - popUpHeight) / 2 + sender.get_element().offsetTop).toString() + "px";

    popUp.style.left = ((jQuery(window).width() - popUpWidth) / 2 + jQuery(window).scrollLeft() )+ "px";
    //popUp.style.top = ((jQuery(window).height()  - popUpHeight) / 2 + jQuery(window).scrollTop()) + "px";
    popUp.style.top = "-20px";
  }

  function clearFields(sender, eventArgs){
    $findByControlId("NoteType").clearSelection();
    $findByControlId("Audience").clearSelection();
    $findByControlId("Note").set_value("");
    $findByControlId("btnClear").set_autoPostBack(false); // cancel post back
    eventArgs.set_cancel(true);
  }

  /*
  //Prevent double clicking Save button
  function disableButton() {
    if ($findByControlId("btnSaveNote")){
      $findByControlId("btnSaveNote").set_enabled(false);
    }
  }
  window.onbeforeunload = disableButton;
  */
</script>
<style>
	.custom-panel-header {
		font-weight: bold;
		font-size: 16px;
		color: #fff;
		font-family: Arial;
	}
	/***** ========= Collapsed Panel Style Start ======== *****/
	.panel-heading {
		cursor: pointer;
		background-color: #002e62;
	}

		.panel-heading:after {
			/* symbol for "opening" panels */
			font-family: 'Glyphicons Halflings';
			/* essential for enabling glyphicon */
			content: "\e114";
			/* adjust as needed, taken from bootstrap.css */
			float: right;
			/* adjust as needed */
			color: #fff;
			/* adjust as needed */
			margin-top: -1.25em;
		}

		.panel-heading.collapsed:after {
			/* symbol for "collapsed" panels */
			content: "\e080";
			/* adjust as needed, taken from bootstrap.css */
		}
	/***** ========= Collapsed Panel Style End ======== *****/
</style>

<div class="sqf-layout" style="padding-top:0px;">
	<div class="sqf-layout-row sqf-placeholder">
		<div class="sqf-section">
			<div class="sqf-row">
				<div class="sqf-col-xs-12 sqf-col-md-12 sqf-control-group-v" style="padding: 0px;">
					<div class="sqf-section" id="notesSection" style="padding: 0px 13px;">
						<div class="sqf-section-row panel-heading" data-toggle="collapse" href="#collapseNotes">
							<h2 class="custom-panel-header"><sq8:Text runat="server" ID="notesSectionLabel" Text="Notes"></sq8:Text></h2>
						</div>
						<div class="sqf-section-body sqf-container panel-collapse collapse in" style="padding:4px 10px 10px;" ID="collapseNotes">

							<asp:UpdatePanel runat="server" ID="NotesGrid">
								<ContentTemplate>
									<sq8:Grid runat="server" ID="refns0NotesGridView" DataSourceID="refns0NotesDataSource"
											  AutoGenerateColumns="False" AutoGenerateDeleteColumn="False" AutoGenerateEditColumn="False" AllowAutomaticDeletes="True" AllowAutomaticInserts="True" AllowAutomaticUpdates="True" GroupPanelPosition="Top" AllowSorting="true" AllowFilteringByColumn="true" PageSize="15">
										<GroupingSettings ExpandAllTooltip="" CollapseAllTooltip=""></GroupingSettings>

										<HierarchySettings ExpandAllTooltip="" CollapseAllTooltip=""></HierarchySettings>

										<ValidationSettings ValidationGroup="vgNotes"></ValidationSettings>

										<ClientSettings>
											<ClientEvents OnPopUpShowing="popUpShowing"></ClientEvents>
										</ClientSettings>
										<ExportSettings ExportOnlyData="True" FileName="BrightServNotes"></ExportSettings>
										<MasterTableView DataKeyNames="fldId" DataSourceID="refns0NotesDataSource" EditMode="PopUp">
											<CommandItemSettings PrevFrozenColumnText="" ShowExportToExcelButton="true" ShowRefreshButton="false"></CommandItemSettings>

											<RowIndicatorColumn FilterControlAltText=""></RowIndicatorColumn>

											<ExpandCollapseColumn FilterControlAltText=""></ExpandCollapseColumn>
											<Columns>
												<sq8:GridBoundColumn DataField="CreationDate" HeaderText="Date" SortExpression="CreationDate" UniqueName="CreationDate" DataType="System.DateTime" FilterControlAltText="" FilterListOptions="VaryByDataType">
													<ColumnValidationSettings>
														<RequiredFieldValidator ForeColor=""></RequiredFieldValidator>
													</ColumnValidationSettings>
												</sq8:GridBoundColumn>
												<sq8:GridBoundColumn DataField="CreatedByName" HeaderText="Entered By" SortExpression="CreatedByName" UniqueName="CreatedByName" FilterControlAltText="" DataType="System.String" FilterListOptions="VaryByDataType" CurrentFilterFunction="Contains" AutoPostBackOnFilter="true">
													<ColumnValidationSettings>
														<RequiredFieldValidator ForeColor=""></RequiredFieldValidator>
													</ColumnValidationSettings>
												</sq8:GridBoundColumn>
												<sq8:GridBoundColumn DataField="UserType" HeaderText="User Type" SortExpression="UserTypeDescription" UniqueName="UserType" FilterControlAltText="" DataType="System.String" FilterListOptions="VaryByDataType" CurrentFilterFunction="Contains" AutoPostBackOnFilter="true">
													<ColumnValidationSettings>
														<RequiredFieldValidator ForeColor=""></RequiredFieldValidator>
													</ColumnValidationSettings>
												</sq8:GridBoundColumn>
												<sq8:GridBoundColumn DataField="NoteType" HeaderText="Note Type" SortExpression="NoteTypeDescription" UniqueName="NoteType" FilterControlAltText="" DataType="System.String" FilterListOptions="VaryByDataType" CurrentFilterFunction="Contains" AutoPostBackOnFilter="true">
													<ColumnValidationSettings>
														<RequiredFieldValidator ForeColor=""></RequiredFieldValidator>
													</ColumnValidationSettings>
												</sq8:GridBoundColumn>
												<sq8:GridBoundColumn DataField="Audience" HeaderText="Audience" SortExpression="AudienceDescription" UniqueName="Audience" FilterControlAltText="" DataType="System.String" FilterListOptions="VaryByDataType" CurrentFilterFunction="Contains" AutoPostBackOnFilter="true">
													<ColumnValidationSettings>
														<RequiredFieldValidator ForeColor=""></RequiredFieldValidator>
													</ColumnValidationSettings>
												</sq8:GridBoundColumn>
												<sq8:GridBoundColumn DataField="Note" HeaderText="Note Description" SortExpression="Note" UniqueName="Note" FilterControlAltText="" DataType="System.String" FilterListOptions="VaryByDataType" CurrentFilterFunction="Contains" AutoPostBackOnFilter="true" EmptyDataText="">
													<ColumnValidationSettings>
														<RequiredFieldValidator ForeColor=""></RequiredFieldValidator>
													</ColumnValidationSettings>
												</sq8:GridBoundColumn>
												<sq8:GridDeleteCommandColumn ConfirmTitle="Title" CommandName="Delete" ButtonType="ImageButton" ConfirmText="Are you sure you want to delete this note?" FilterControlAltText="" UniqueName="Delete" Visible='<% $ sq: {IIF ({DataModel}.Query("ref:ns0/USP_IsGroupManager", new object[]{rt.CurrentUser.UserId, null}).last()["IsGroupManager"] = true, True, False)} %>'></sq8:GridDeleteCommandColumn>
											</Columns>

											<EditFormSettings EditFormType="Template" InsertCaption="Add New Note">
												<PopUpSettings Modal="true"></PopUpSettings>
												<EditColumn FilterControlAltText=""></EditColumn>
												<FormTemplate>
													<script language="javascript">

                          $(document).ready(function(){
                            var noteType = $findByControlId("NoteType").get_value();
                            /**/
                            if(noteType)
                            {
                              var currentUserId = "<%={rt.CurrentUser.UserId} %> %>";
                              $findByControlId("LastUpdateDate").set_selectedDate(new Date());
                              $findByControlId("LastUpdatedBy").set_value(currentUserId);
                            }
                          });

													</script>
													<div class="sqf-section">
														<div class="sqf-row">
															<div class="sqf-col-xs-12 sqf-control-group-v">
																<sq8:Label runat="server" Text="Note Type">
																	&nbsp;
																	<sq8:Label runat="server" Text="*" ID="lblNoteTypeRequired" ForeColor="#FB836F"></sq8:Label>
																</sq8:Label>
																<sq8:DataSource runat="server" ID="NoteTypeDataSource" QueryName="ref:ns0/NoteTypes"></sq8:DataSource>
																<sq8:ComboBox runat="server" ID="NoteType" DataSourceID="NoteTypeDataSource"
																			  DataTextField="Description" DataValueField="Code" AutoInsertEmptyItem="true" EmptyMessage="- Select Note Type -">
																</sq8:ComboBox>
																<asp:RequiredFieldValidator runat="server" Display="Dynamic" ErrorMessage="Note Type is required" ID="rfvNoteType" ControlToValidate="NoteType" ValidationGroup="vgNotes"></asp:RequiredFieldValidator>
																<sq:BindableControl runat="server" TargetControlID="NoteType" DataField="NoteType"></sq:BindableControl>
															</div>
														</div>
														<div class="sqf-row">
															<div class="sqf-col-xs-12 sqf-control-group-v">
																<sq8:Label runat="server" Text="Audience">
																	&nbsp;
																	<sq8:Label runat="server" Text="*" ID="lblAudienceRequired" ForeColor="#FB836F"></sq8:Label>
																</sq8:Label>
																<sq8:DataSource runat="server" ID="AudienceDataSource" QueryName="ref:ns0/AudienceTypes"></sq8:DataSource>
																<sq8:ComboBox runat="server" ID="Audience" DataSourceID="AudienceDataSource"
																			  DataTextField="Description" DataValueField="Code" AutoInsertEmptyItem="true" EmptyMessage="- Select Audience -">
																</sq8:ComboBox>
																<asp:RequiredFieldValidator runat="server" Display="Dynamic" ErrorMessage="Audience is required" ID="rfvAudience" ControlToValidate="Audience" ValidationGroup="vgNotes"></asp:RequiredFieldValidator>
																<sq:BindableControl runat="server" TargetControlID="Audience" DataField="Audience"></sq:BindableControl>
															</div>
														</div>
														<div class="sqf-row">
															<div class="sqf-col-xs-12 sqf-control-group-v">
																<sq8:Label runat="server" Text="Note">
																	&nbsp;
																	<sq8:Label runat="server" Text="*" ID="lblNoteRequired" ForeColor="#FB836F"></sq8:Label>
																</sq8:Label>
																<sq8:TextBox runat="server" ID="Note" TextMode="MultiLine" Rows="5" Columns="50"></sq8:TextBox>
																<asp:RequiredFieldValidator runat="server" Display="Dynamic" ErrorMessage="Notes are required" ID="rfvNotes" ControlToValidate="Note" ValidationGroup="vgNotes"></asp:RequiredFieldValidator>
																<sq:BindableControl runat="server" TargetControlID="Note" DataField="Note"></sq:BindableControl>
															</div>
														</div>

														<div style="display:none">
															<div class="sqf-row">
																<div class="sqf-col-xs-12 sqf-control-group-v">
																	<sq8:Label runat="server" Text="CreationDate" />
																	<sq8:DateTimePicker runat="server" ID="CreationDate"></sq8:DateTimePicker>
																	<asp:RequiredFieldValidator runat="server" Display="Static" ErrorMessage="CreationDate must be filled" ID="rfvCreationDate" ControlToValidate="CreationDate"></asp:RequiredFieldValidator>
																	<sq:BindableControl runat="server" TargetControlID="CreationDate" DataField="CreationDate"></sq:BindableControl>
																</div>
															</div>
															<div class="sqf-row">
																<div class="sqf-col-xs-12 sqf-control-group-v">
																	<sq8:Label runat="server" Text="CreatedBy" />
																	<sq8:NumericTextBox runat="server" ID="CreatedBy"
																						DataType="System.Int32"></sq8:NumericTextBox>
																	<asp:RequiredFieldValidator runat="server" Display="Dynamic" ErrorMessage="CreatedBy must be filled" ID="rfvCreatedBy" ControlToValidate="CreatedBy"></asp:RequiredFieldValidator>
																	<sq:BindableControl runat="server" TargetControlID="CreatedBy" DataField="CreatedBy"></sq:BindableControl>
																</div>
															</div>
															<div class="sqf-row">
																<div class="sqf-col-xs-12 sqf-control-group-v">
																	<sq8:Label runat="server" Text="LastUpdateDate" />
																	<sq8:DateTimePicker runat="server" ID="LastUpdateDate">
																	</sq8:DateTimePicker>
																	<sq:BindableControl runat="server" TargetControlID="LastUpdateDate" DataField="LastUpdateDate"></sq:BindableControl>
																</div>
															</div>
															<div class="sqf-row">
																<div class="sqf-col-xs-12 sqf-control-group-v">
																	<sq8:Label runat="server" Text="LastUpdatedBy" />
																	<sq8:NumericTextBox runat="server" ID="LastUpdatedBy"
																						DataType="System.Int32"></sq8:NumericTextBox>
																	<sq:BindableControl runat="server" TargetControlID="LastUpdatedBy" DataField="LastUpdatedBy"></sq:BindableControl>
																</div>
															</div>
															<div class="sqf-row">
																<div class="sqf-col-xs-12 sqf-control-group-v">
																	<sq8:Label runat="server" Text="UserType" />
																	<sq8:DataSource runat="server" ID="UserTypeDataSource" QueryName="ref:ns0/UserTypes"></sq8:DataSource>
																	<sq8:ComboBox runat="server" ID="UserType" DataSourceID="UserTypeDataSource"
																				  DataTextField="Description" DataValueField="Code">
																	</sq8:ComboBox>
																	<sq:BindableControl runat="server" TargetControlID="UserType" DataField="UserType"></sq:BindableControl>
																</div>
															</div>
															<div class="sqf-row">
																<div class="sqf-col-xs-12 sqf-control-group-v">
																	<sq8:Label runat="server" Text="CreatedByName" />
																	<sq8:TextBox runat="server" ID="CreatedByName"></sq8:TextBox>
																	<sq:BindableControl runat="server" TargetControlID="CreatedByName" DataField="CreatedByName"></sq:BindableControl>
																</div>
															</div>

														</div>

														<div class="sqf-row">
															<div class="sqf-col-xs-12 sqf-control-group-v text-center">
																<sq8:Button runat="server" Text="Clear" ID="btnClear" UseSubmitBehavior="false" AutoPostBack="false" CausesValidation="false" OnClientClicking="clearFields"></sq8:Button>&nbsp;&nbsp;
																<sq8:Button runat="server" Text="Save" ID="btnSaveNote" CommandName="PerformUpsert" ValidationGroup="vgNotes" SingleClick="true" SingleClickText="Save Note"></sq8:Button>
															</div>
														</div>
													</div>

												</FormTemplate>
											</EditFormSettings>

											<PagerStyle GoToPageButtonToolTip=""></PagerStyle>

											<AutoGeneratedEditColumnSettings ButtonType="ImageButton"></AutoGeneratedEditColumnSettings>

											<AutoGeneratedDeleteColumnSettings ButtonType="ImageButton"></AutoGeneratedDeleteColumnSettings>
										</MasterTableView>

										<PagerStyle GoToPageButtonToolTip=""></PagerStyle>

										<FilterMenu EnableImageSprites="True"></FilterMenu>
									</sq8:Grid>


								</ContentTemplate>
							</asp:UpdatePanel>

							<sq8:DataSource runat="server" ID="refns0NotesDataSource"
											QueryName="ref:ns0/Notes" OrderBy="CreationDate desc" Where="AudienceCode == @Public || AudienceCode == @Vendor || @IsVendor == False">
								<WhereParameters>
									<sq:ExpressionParameter Expression="&quot;PUBLIC&quot;" Name="Public"></sq:ExpressionParameter>
									<sq:ExpressionParameter Expression="&quot;VENDOR&quot;" Name="Vendor"></sq:ExpressionParameter>
									<sq:ExpressionParameter Expression="Join(MemberOf(rt, rt.currentuser.userId), &quot;,&quot;).contains(&quot;Vendors&quot;)" Name="IsVendor"></sq:ExpressionParameter>
								</WhereParameters>
							</sq8:DataSource>

							<sq:BoundControl runat="server" TargetControlID="refns0NotesGridView"></sq:BoundControl>

						</div>

					</div>
				</div>
			</div>
		</div>
	</div>
</div>

